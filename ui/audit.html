<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PII Shield - Audit Logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .audit-table {
            font-size: 0.875rem;
        }

        .audit-row:hover {
            background-color: #f3f4f6;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge-mask {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .badge-unmask {
            background-color: #fef3c7;
            color: #92400e;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold">üõ°Ô∏è PII Shield - Audit Logs</h1>
                    <p class="text-sm opacity-90">Immutable audit trail for all PII operations</p>
                </div>
                <a href="/"
                    class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition font-semibold">
                    ‚Üê Back to Demo
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <!-- Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <label class="font-semibold text-gray-700">Show:</label>
                    <select id="limitSelect"
                        class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="10">10 entries</option>
                        <option value="25">25 entries</option>
                        <option value="50" selected>50 entries</option>
                        <option value="100">100 entries</option>
                    </select>
                    <button id="refreshBtn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold">
                        üîÑ Refresh
                    </button>
                </div>
                <div id="statsBox" class="text-sm text-gray-600">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full audit-table">
                    <thead class="bg-gradient-to-r from-gray-700 to-gray-800 text-white">
                        <tr>
                            <th class="px-4 py-3 text-left">Timestamp</th>
                            <th class="px-4 py-3 text-left">Operation</th>
                            <th class="px-4 py-3 text-left">Session ID</th>
                            <th class="px-4 py-3 text-left">User</th>
                            <th class="px-4 py-3 text-left">PII Types</th>
                            <th class="px-4 py-3 text-left">Purpose</th>
                            <th class="px-4 py-3 text-left">Status</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <div class="animate-pulse">Loading audit logs...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden bg-white rounded-lg shadow-md p-12 text-center">
            <div class="text-6xl mb-4">üìã</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No Audit Logs Found</h3>
            <p class="text-gray-500">Start using the PII Shield to see audit entries here.</p>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api/v1';
        const limitSelect = document.getElementById('limitSelect');
        const refreshBtn = document.getElementById('refreshBtn');
        const statsBox = document.getElementById('statsBox');
        const tableBody = document.getElementById('auditTableBody');
        const emptyState = document.getElementById('emptyState');

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function getOperationBadge(operation) {
            const classes = {
                'MASK': 'badge-mask',
                'UNMASK': 'badge-unmask'
            };
            return `<span class="badge ${classes[operation] || 'badge-mask'}">${operation}</span>`;
        }

        function getStatusBadge(success) {
            return success
                ? '<span class="badge badge-success">‚úì Success</span>'
                : '<span class="badge badge-error">‚úó Failed</span>';
        }

        function formatPIITypes(types) {
            if (!types || types.length === 0) return '<span class="text-gray-400">None</span>';
            try {
                const parsed = typeof types === 'string' ? JSON.parse(types) : types;
                return parsed.map(type =>
                    `<span class="inline-block bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs mr-1 mb-1">${type}</span>`
                ).join('');
            } catch {
                return types;
            }
        }

        async function loadAuditLogs() {
            const limit = limitSelect.value;

            try {
                const response = await fetch(`${API_URL}/audit?limit=${limit}`);
                const logs = await response.json();

                if (logs.length === 0) {
                    tableBody.closest('div.bg-white').classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    statsBox.textContent = 'No entries found';
                    return;
                }

                tableBody.closest('div.bg-white').classList.remove('hidden');
                emptyState.classList.add('hidden');

                // Update stats
                statsBox.textContent = `Showing ${logs.length} entries`;

                // Populate table
                tableBody.innerHTML = logs.map(log => `
                    <tr class="audit-row">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${formatTimestamp(log.timestamp)}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            ${getOperationBadge(log.operation)}
                        </td>
                        <td class="px-4 py-3 font-mono text-xs text-gray-600">
                            ${log.session_id || '<span class="text-gray-400">N/A</span>'}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <div class="text-gray-700">${log.user_id || '<span class="text-gray-400">Unknown</span>'}</div>
                            <div class="text-xs text-gray-500">${log.user_role || 'guest'}</div>
                        </td>
                        <td class="px-4 py-3">
                            ${formatPIITypes(log.pii_types_accessed)}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${log.purpose || '<span class="text-gray-400">N/A</span>'}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            ${getStatusBadge(log.success)}
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading audit logs:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-red-600">
                            ‚ùå Error loading audit logs: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Event listeners
        refreshBtn.addEventListener('click', loadAuditLogs);
        limitSelect.addEventListener('change', loadAuditLogs);

        // Initial load
        loadAuditLogs();

        // Auto-refresh every 10 seconds
        setInterval(loadAuditLogs, 10000);
    </script>
</body>

</html>